# Arquitectura T√©cnica - AutoTaller Pro

## üìã Resumen Ejecutivo

AutoTaller Pro es un sistema de gesti√≥n de talleres automotrices construido con arquitectura moderna de separaci√≥n frontend/backend, utilizando Laravel 12.x como API backend y React 18.x con TypeScript como SPA frontend.

## üèóÔ∏è Arquitectura General

### Separaci√≥n de Responsabilidades

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend SPA  ‚îÇ    ‚îÇ   Backend API   ‚îÇ    ‚îÇ   Database      ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ   React 18.x    ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   Laravel 12.x  ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   SQLite/Pgsql  ‚îÇ
‚îÇ   TypeScript    ‚îÇ    ‚îÇ   PHP 8.2+      ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ   Vite          ‚îÇ    ‚îÇ   Sanctum Auth  ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flujo de Datos

```
User Interaction ‚Üí React Components ‚Üí Zustand Store ‚Üí API Service ‚Üí Laravel Controller ‚Üí Service Layer ‚Üí Eloquent Model ‚Üí Database
```

## üîß Backend Architecture (Laravel)

### Estructura de Directorios

```
app/
‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ API/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CustomerController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ VehicleController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WorkOrderController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AuthController.php
‚îÇ   ‚îú‚îÄ‚îÄ Requests/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StoreCustomerRequest.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UpdateCustomerRequest.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ Resources/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CustomerResource.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WorkOrderResource.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ Middleware/
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ Customer.php
‚îÇ   ‚îú‚îÄ‚îÄ Vehicle.php
‚îÇ   ‚îú‚îÄ‚îÄ WorkOrder.php
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ WorkOrderService.php
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ Events/
‚îÇ   ‚îú‚îÄ‚îÄ WorkOrderStatusChanged.php
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ Listeners/
‚îÇ   ‚îú‚îÄ‚îÄ SendWorkOrderNotification.php
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ Policies/
    ‚îú‚îÄ‚îÄ WorkOrderPolicy.php
    ‚îî‚îÄ‚îÄ ...
```

### Patrones Implementados

#### 1. Service Layer Pattern
```php
class WorkOrderService
{
    public function create(array $data): WorkOrder
    {
        DB::beginTransaction();
        try {
            $workOrder = WorkOrder::create($data);
            $this->addParts($workOrder, $data['parts'] ?? []);
            $this->calculateTotalCost($workOrder);
            DB::commit();
            return $workOrder;
        } catch (Exception $e) {
            DB::rollBack();
            throw $e;
        }
    }
}
```

#### 2. Event-Driven Architecture
```php
// Event
class WorkOrderStatusChanged
{
    public function __construct(
        public WorkOrder $workOrder,
        public string $oldStatus
    ) {}
}

// Listener
class SendWorkOrderNotification
{
    public function handle(WorkOrderStatusChanged $event): void
    {
        // Send notification logic
    }
}
```

#### 3. Policy-Based Authorization
```php
class WorkOrderPolicy
{
    public function view(User $user, WorkOrder $workOrder): bool
    {
        return $user->can('view work orders') || 
               $workOrder->customer_id === $user->customer_id;
    }
}
```

### API Design Principles

#### RESTful Endpoints
```
GET    /api/v1/work-orders           # List with pagination
POST   /api/v1/work-orders           # Create new
GET    /api/v1/work-orders/{id}      # Show specific
PUT    /api/v1/work-orders/{id}      # Update
DELETE /api/v1/work-orders/{id}      # Delete
POST   /api/v1/work-orders/{id}/status # Custom action
```

#### Consistent Response Format
```json
{
  "data": {
    "id": 1,
    "order_number": "WO-2024-001",
    "customer": {
      "id": 1,
      "first_name": "Juan",
      "last_name": "P√©rez"
    }
  },
  "meta": {
    "current_page": 1,
    "per_page": 15,
    "total": 100
  }
}
```

## ‚öõÔ∏è Frontend Architecture (React)

### Estructura de Directorios

```
resources/js/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ Layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Button.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Modal.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Table.tsx
‚îÇ   ‚îî‚îÄ‚îÄ forms/
‚îÇ       ‚îú‚îÄ‚îÄ CustomerForm.tsx
‚îÇ       ‚îî‚îÄ‚îÄ WorkOrderForm.tsx
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ Dashboard.tsx
‚îÇ   ‚îú‚îÄ‚îÄ WorkOrders.tsx
‚îÇ   ‚îú‚îÄ‚îÄ Customers.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useWorkOrders.ts
‚îÇ   ‚îú‚îÄ‚îÄ useCustomers.ts
‚îÇ   ‚îî‚îÄ‚îÄ useAuth.ts
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ api.ts
‚îÇ   ‚îú‚îÄ‚îÄ workOrderService.ts
‚îÇ   ‚îî‚îÄ‚îÄ authService.ts
‚îú‚îÄ‚îÄ store/
‚îÇ   ‚îú‚îÄ‚îÄ useAuthStore.ts
‚îÇ   ‚îú‚îÄ‚îÄ useWorkOrderStore.ts
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îî‚îÄ‚îÄ api.ts
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ formatters.ts
    ‚îú‚îÄ‚îÄ validators.ts
    ‚îî‚îÄ‚îÄ constants.ts
```

### Estado Global con Zustand

```typescript
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  login: (user: User, token: string) => void;
  logout: () => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      token: null,
      isAuthenticated: false,
      login: (user, token) => set({ user, token, isAuthenticated: true }),
      logout: () => set({ user: null, token: null, isAuthenticated: false }),
    }),
    { name: 'auth-storage' }
  )
);
```

### Custom Hooks para L√≥gica Reutilizable

```typescript
export function useWorkOrders(filters?: WorkOrderFilters) {
  return useQuery({
    queryKey: ['workOrders', filters],
    queryFn: () => workOrderService.getAll(filters),
    staleTime: 5 * 60 * 1000, // 5 minutes
  });
}

export function useCreateWorkOrder() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: workOrderService.create,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['workOrders'] });
    },
  });
}
```

### TypeScript Interfaces

```typescript
export interface WorkOrder {
  id: number;
  order_number: string;
  customer_id: number;
  vehicle_id: number;
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled';
  priority: 'low' | 'medium' | 'high' | 'urgent';
  total_cost: number;
  customer?: Customer;
  vehicle?: Vehicle;
  created_at: string;
  updated_at: string;
}
```

## üóÑÔ∏è Database Architecture

### Esquema de Relaciones

```sql
customers (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) vehicles
    ‚îÇ                   ‚îÇ
    ‚îÇ                   ‚îÇ
    ‚îî‚îÄ‚îÄ (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) work_orders ‚îÄ‚îÄ‚îÄ‚îÄ (N) vehicles
                      ‚îÇ
                      ‚îú‚îÄ‚îÄ (N) ‚îÄ‚îÄ‚îÄ‚îÄ (N) parts (work_order_parts)
                      ‚îî‚îÄ‚îÄ (N) ‚îÄ‚îÄ‚îÄ‚îÄ (N) mechanics (work_order_mechanics)

mechanics (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) appointments ‚îÄ‚îÄ‚îÄ‚îÄ (1) customers
                                    ‚îî‚îÄ‚îÄ (1) vehicles
```

### Migraciones Avanzadas

```php
Schema::create('work_orders', function (Blueprint $table) {
    $table->id();
    $table->string('order_number')->unique();
    $table->foreignId('customer_id')->constrained()->onDelete('cascade');
    $table->foreignId('vehicle_id')->constrained()->onDelete('cascade');
    $table->foreignId('assigned_mechanic_id')->nullable()
          ->constrained('mechanics')->onDelete('set null');
    $table->text('problem_description');
    $table->decimal('total_cost', 10, 2)->default(0);
    $table->enum('status', ['pending', 'in_progress', 'completed', 'cancelled']);
    $table->enum('priority', ['low', 'medium', 'high', 'urgent']);
    $table->json('images')->nullable();
    $table->timestamps();
    
    $table->index(['status', 'priority']);
    $table->index('customer_id');
    $table->index('assigned_mechanic_id');
});
```

### Modelos Eloquent con Relaciones

```php
class WorkOrder extends Model
{
    protected $casts = [
        'images' => 'array',
        'total_cost' => 'decimal:2',
        'started_at' => 'datetime',
        'completed_at' => 'datetime',
    ];

    public function customer(): BelongsTo
    {
        return $this->belongsTo(Customer::class);
    }

    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(Vehicle::class);
    }

    public function parts(): BelongsToMany
    {
        return $this->belongsToMany(Part::class, 'work_order_parts')
                    ->withPivot(['quantity', 'unit_price', 'total_price'])
                    ->withTimestamps();
    }

    // Auto-generate order number
    protected static function boot()
    {
        parent::boot();
        
        static::creating(function ($workOrder) {
            if (!$workOrder->order_number) {
                $year = date('Y');
                $count = static::whereYear('created_at', $year)->count() + 1;
                $workOrder->order_number = "WO-{$year}-" . str_pad($count, 4, '0', STR_PAD_LEFT);
            }
        });
    }
}
```

## üîê Seguridad

### Autenticaci√≥n con Sanctum

```php
// Login
public function login(Request $request)
{
    $credentials = $request->validate([
        'email' => 'required|email',
        'password' => 'required',
    ]);

    if (!Auth::attempt($credentials)) {
        throw ValidationException::withMessages([
            'email' => ['The provided credentials are incorrect.'],
        ]);
    }

    $user = Auth::user();
    $token = $user->createToken('auth-token')->plainTextToken;

    return response()->json([
        'user' => new UserResource($user),
        'token' => $token,
    ]);
}
```

### Autorizaci√≥n con Policies

```php
class WorkOrderController extends Controller
{
    public function __construct()
    {
        $this->middleware('auth:sanctum');
        $this->middleware('permission:view work orders')->only(['index', 'show']);
        $this->middleware('permission:create work orders')->only('store');
        $this->middleware('permission:edit work orders')->only('update');
    }

    public function show(WorkOrder $workOrder)
    {
        $this->authorize('view', $workOrder);
        return new WorkOrderResource($workOrder->load(['customer', 'vehicle']));
    }
}
```

### Validaci√≥n Robusta

```php
class StoreWorkOrderRequest extends FormRequest
{
    public function rules(): array
    {
        return [
            'customer_id' => 'required|exists:customers,id',
            'vehicle_id' => 'required|exists:vehicles,id',
            'problem_description' => 'required|string|max:1000',
            'priority' => 'required|in:low,medium,high,urgent',
            'estimated_hours' => 'nullable|integer|min:1|max:100',
            'parts' => 'nullable|array',
            'parts.*.part_id' => 'required_with:parts|exists:parts,id',
            'parts.*.quantity' => 'required_with:parts|integer|min:1',
        ];
    }

    public function authorize(): bool
    {
        return $this->user()->can('create work orders');
    }
}
```

## üöÄ Performance Optimization

### Backend Optimizations

#### Query Optimization
```php
// Eager Loading to prevent N+1
$workOrders = WorkOrder::with(['customer', 'vehicle', 'assignedMechanic'])
    ->where('status', 'in_progress')
    ->get();

// Query Scopes
class WorkOrder extends Model
{
    public function scopeInProgress($query)
    {
        return $query->where('status', 'in_progress');
    }

    public function scopeHighPriority($query)
    {
        return $query->where('priority', 'high');
    }
}
```

#### Caching Strategy
```php
public function index(Request $request)
{
    $cacheKey = 'work_orders_' . md5(serialize($request->all()));
    
    $workOrders = Cache::tags(['work_orders'])
        ->remember($cacheKey, 300, function () use ($request) {
            return WorkOrder::with(['customer', 'vehicle'])
                ->when($request->status, fn($q) => $q->where('status', $request->status))
                ->paginate(15);
        });
    
    return WorkOrderResource::collection($workOrders);
}

// Cache invalidation
public function update(WorkOrder $workOrder, UpdateWorkOrderRequest $request)
{
    $workOrder->update($request->validated());
    Cache::tags(['work_orders'])->flush();
    return new WorkOrderResource($workOrder);
}
```

### Frontend Optimizations

#### Code Splitting
```typescript
// Lazy loading pages
const Dashboard = lazy(() => import('@/pages/Dashboard'));
const WorkOrders = lazy(() => import('@/pages/WorkOrders'));

// Route-based splitting
<Route 
  path="/work-orders" 
  element={
    <Suspense fallback={<Loading />}>
      <WorkOrders />
    </Suspense>
  } 
/>
```

#### React Query Optimizations
```typescript
// Prefetching
function useWorkOrdersWithPrefetch() {
  const queryClient = useQueryClient();
  
  return useQuery({
    queryKey: ['workOrders'],
    queryFn: workOrderService.getAll,
    onSuccess: (data) => {
      // Prefetch individual work orders
      data.forEach(workOrder => {
        queryClient.setQueryData(['workOrders', workOrder.id], workOrder);
      });
    },
  });
}

// Background refetching
export function useWorkOrders() {
  return useQuery({
    queryKey: ['workOrders'],
    queryFn: workOrderService.getAll,
    staleTime: 5 * 60 * 1000, // 5 minutes
    refetchInterval: 30 * 1000, // 30 seconds
  });
}
```

## üìä Monitoreo y Logging

### Logging Estructurado
```php
Log::info('Work order created', [
    'work_order_id' => $workOrder->id,
    'customer_id' => $workOrder->customer_id,
    'user_id' => auth()->id(),
    'ip_address' => request()->ip(),
]);

Log::warning('Low stock alert', [
    'part_id' => $part->id,
    'current_stock' => $part->stock_quantity,
    'min_level' => $part->min_stock_level,
]);
```

### Error Handling
```typescript
// Frontend error boundary
class ErrorBoundary extends Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    console.error('Error caught by boundary:', error, errorInfo);
    // Send to monitoring service
  }

  render() {
    if (this.state.hasError) {
      return <ErrorFallback />;
    }
    return this.props.children;
  }
}
```

## üß™ Testing Strategy

### Backend Testing
```php
class WorkOrderControllerTest extends TestCase
{
    use RefreshDatabase;

    public function test_can_create_work_order()
    {
        $user = User::factory()->create();
        $customer = Customer::factory()->create();
        $vehicle = Vehicle::factory()->create(['customer_id' => $customer->id]);

        $response = $this->actingAs($user, 'sanctum')
            ->postJson('/api/v1/work-orders', [
                'customer_id' => $customer->id,
                'vehicle_id' => $vehicle->id,
                'problem_description' => 'Engine noise',
                'priority' => 'medium',
            ]);

        $response->assertStatus(201)
                ->assertJsonStructure(['data' => ['id', 'order_number']]);
    }
}
```

### Frontend Testing
```typescript
// Unit test with React Testing Library
import { render, screen } from '@testing-library/react';
import { WorkOrderCard } from '@/components/WorkOrderCard';

test('displays work order information', () => {
  const workOrder = {
    id: 1,
    order_number: 'WO-2024-001',
    customer: { first_name: 'Juan', last_name: 'P√©rez' },
    status: 'in_progress',
  };

  render(<WorkOrderCard workOrder={workOrder} />);
  
  expect(screen.getByText('WO-2024-001')).toBeInTheDocument();
  expect(screen.getByText('Juan P√©rez')).toBeInTheDocument();
  expect(screen.getByText('En Progreso')).toBeInTheDocument();
});
```

## üîÑ CI/CD Pipeline

### GitHub Actions
```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        
    - name: Install dependencies
      run: composer install
      
    - name: Run tests
      run: php artisan test
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      run: npm install
      
    - name: Build frontend
      run: npm run build
      
    - name: Run frontend tests
      run: npm test
```

Esta arquitectura t√©cnica proporciona una base s√≥lida, escalable y mantenible para el sistema AutoTaller Pro, siguiendo las mejores pr√°cticas de desarrollo senior tanto en backend como frontend.